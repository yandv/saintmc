package tk.yallandev.saintmc.bukkit.exploit.register;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;

import io.netty.buffer.ByteBuf;
import tk.yallandev.saintmc.CommonGeneral;
import tk.yallandev.saintmc.bukkit.BukkitMain;
import tk.yallandev.saintmc.bukkit.exploit.Exploit;

public class PacketLimiterExploit implements Exploit {

	public List<UUID> uuids = new ArrayList<>();

	@Override
	public void register() {
		ProtocolLibrary.getProtocolManager().addPacketListener(new PacketAdapter(BukkitMain.getInstance(),
				ListenerPriority.LOWEST, PacketType.Play.Client.WINDOW_CLICK, PacketType.Play.Client.CUSTOM_PAYLOAD) {
			@Override
			public void onPacketReceiving(PacketEvent event) {
				if (event.getPacketType() == PacketType.Play.Client.WINDOW_CLICK) {
					if (event.getPlayer() == null)
						return;

					if ((int) event.getPacket().getModifier().getValues().get(1) >= 100) {
						disconnect(event.getPlayer(), "Netty 2", true);
						event.setCancelled(true);
						CommonGeneral.getInstance()
								.debug(event.getPlayer().getName() + " tried to crash the server with netty 2!");
					}
				} else {
					String packetName = event.getPacket().getStrings().getValues().get(0);

					if (packetName.equals("MC|BEdit") || packetName.equals("MC|BSign")) {
						if (((ByteBuf) event.getPacket().getModifier().getValues().get(1)).capacity() > 7500) {
							if (uuids.contains(event.getPlayer().getUniqueId()))
								disconnect(event.getPlayer(), "Book Flooder", true);
							else
								uuids.add(event.getPlayer().getUniqueId());

							event.setCancelled(true);
						}
					}
				}
			}
		});
	}

}
