package tk.yallandev.saintmc.bukkit.exploit.register;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;

import io.netty.buffer.ByteBuf;
import tk.yallandev.saintmc.bukkit.BukkitMain;
import tk.yallandev.saintmc.bukkit.exploit.Exploit;

public class JigsawExploit implements Exploit {

	public List<UUID> uuids = new ArrayList<>();

	@Override
	public void register() {
		ProtocolLibrary.getProtocolManager().getAsynchronousManager().registerAsyncHandler(
				new PacketAdapter(BukkitMain.getInstance(), PacketType.Play.Client.CUSTOM_PAYLOAD) {

					@Override
					public void onPacketReceiving(PacketEvent event) {
						String packetName = event.getPacket().getStrings().getValues().get(0);

						if (packetName.equals("MC|BEdit") || packetName.equals("MC|BSign")) {
							if (((ByteBuf) event.getPacket().getModifier().getValues().get(1)).capacity() > 30000) {

								if (uuids.contains(event.getPlayer().getUniqueId()))
									disconnect(event.getPlayer(), "Book Flooder");
								else
									uuids.add(event.getPlayer().getUniqueId());

								event.setCancelled(true);
							}
						}
					}

				}).start();
	}

}
